import*as Log from"./util/logging.min.js";import _,{l10n}from"./localization.min.js";import{isTouchDevice,isSafari,hasScrollbarGutter,dragThreshold}from"./util/browser.min.js";import{setCapture,getPointerEvent}from"./util/events.min.js";import KeyTable from"./input/keysym.min.js";import keysyms from"./input/keysymdef.min.js";import Keyboard from"./input/keyboard.min.js";import RFB from"./rfb.min.js";import*as WebUtil from"./webutil.min.js";const PAGE_TITLE="noVNC",UI={connected:!1,desktopName:"",statusTimeout:null,hideKeyboardTimeout:null,idleControlbarTimeout:null,closeControlbarTimeout:null,controlbarGrabbed:!1,controlbarDrag:!1,controlbarMouseDownClientY:0,controlbarMouseDownOffsetY:0,lastKeyboardinput:null,defaultKeyboardinputLen:100,inhibitReconnect:!0,reconnectCallback:null,reconnectPassword:null,prime:()=>WebUtil.initSettings().then(()=>"interactive"===document.readyState||"complete"===document.readyState?UI.start():new Promise((resolve,reject)=>{document.addEventListener("DOMContentLoaded",()=>UI.start().then(resolve).catch(reject))})),start(){UI.initSettings(),l10n.translateDOM(),window.isSecureContext||UI.showStatus(_("HTTPS is required for full functionality"),"error"),Array.from(document.getElementsByClassName("noVNC_version")).forEach(el=>el.innerText="1.3.0"),isTouchDevice&&setTimeout(()=>window.scrollTo(0,1),100),"right"===WebUtil.readSetting("controlbar_pos")&&UI.toggleControlbarSide(),UI.initFullscreen(),UI.addControlbarHandlers(),UI.addTouchSpecificHandlers(),UI.addExtraKeysHandlers(),UI.addMachineHandlers(),UI.addConnectionControlHandlers(),UI.addClipboardHandlers(),UI.addSettingsHandlers(),document.getElementById("noVNC_status").addEventListener("click",UI.hideStatus),UI.keyboardinputReset(),UI.openControlbar(),UI.updateVisualState("init"),document.documentElement.classList.remove("noVNC_loading");let autoconnect=WebUtil.getConfigVar("autoconnect",!1);return"true"===autoconnect||"1"==autoconnect?(autoconnect=!0,UI.connect()):(autoconnect=!1,UI.openConnectPanel()),Promise.resolve(UI.rfb)},initFullscreen(){!isSafari()&&(document.documentElement.requestFullscreen||document.documentElement.mozRequestFullScreen||document.documentElement.webkitRequestFullscreen||document.body.msRequestFullscreen)&&(document.getElementById("noVNC_fullscreen_button").classList.remove("noVNC_hidden"),UI.addFullscreenHandlers())},initSettings(){const llevels=["error","warn","info","debug"];for(let i=0;i<llevels.length;i+=1)UI.addOption(document.getElementById("noVNC_setting_logging"),llevels[i],llevels[i]);UI.initSetting("logging","warn"),UI.updateLogging();let port=window.location.port;port||("https"==window.location.protocol.substring(0,5)?port=443:"http"==window.location.protocol.substring(0,4)&&(port=80)),UI.initSetting("host",window.location.hostname),UI.initSetting("port",port),UI.initSetting("encrypt","https:"===window.location.protocol),UI.initSetting("view_clip",!1),UI.initSetting("resize","off"),UI.initSetting("quality",6),UI.initSetting("compression",2),UI.initSetting("shared",!0),UI.initSetting("view_only",!1),UI.initSetting("show_dot",!1),UI.initSetting("path","websockify"),UI.initSetting("repeaterID",""),UI.initSetting("reconnect",!1),UI.initSetting("reconnect_delay",5e3),UI.setupSettingLabels()},setupSettingLabels(){const labels=document.getElementsByTagName("LABEL");for(let i=0;i<labels.length;i++){const htmlFor=labels[i].htmlFor;if(""!=htmlFor){const elem=document.getElementById(htmlFor);elem&&(elem.label=labels[i])}else{const children=labels[i].children;for(let j=0;j<children.length;j++)if(void 0!==children[j].form){children[j].label=labels[i];break}}}},addControlbarHandlers(){document.getElementById("noVNC_control_bar").addEventListener("mousemove",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("mouseup",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("mousedown",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("keydown",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("mousedown",UI.keepControlbar),document.getElementById("noVNC_control_bar").addEventListener("keydown",UI.keepControlbar),document.getElementById("noVNC_view_drag_button").addEventListener("click",UI.toggleViewDrag),document.getElementById("noVNC_control_bar_handle").addEventListener("mousedown",UI.controlbarHandleMouseDown),document.getElementById("noVNC_control_bar_handle").addEventListener("mouseup",UI.controlbarHandleMouseUp),document.getElementById("noVNC_control_bar_handle").addEventListener("mousemove",UI.dragControlbarHandle),window.addEventListener("resize",UI.updateControlbarHandle);const exps=document.getElementsByClassName("noVNC_expander");for(let i=0;i<exps.length;i++)exps[i].addEventListener("click",UI.toggleExpander)},addTouchSpecificHandlers(){document.getElementById("noVNC_keyboard_button").addEventListener("click",UI.toggleVirtualKeyboard),UI.touchKeyboard=new Keyboard(document.getElementById("noVNC_keyboardinput")),UI.touchKeyboard.onkeyevent=UI.keyEvent,UI.touchKeyboard.grab(),document.getElementById("noVNC_keyboardinput").addEventListener("input",UI.keyInput),document.getElementById("noVNC_keyboardinput").addEventListener("focus",UI.onfocusVirtualKeyboard),document.getElementById("noVNC_keyboardinput").addEventListener("blur",UI.onblurVirtualKeyboard),document.getElementById("noVNC_keyboardinput").addEventListener("submit",()=>!1),document.documentElement.addEventListener("mousedown",UI.keepVirtualKeyboard,!0),document.getElementById("noVNC_control_bar").addEventListener("touchstart",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("touchmove",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("touchend",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("input",UI.activateControlbar),document.getElementById("noVNC_control_bar").addEventListener("touchstart",UI.keepControlbar),document.getElementById("noVNC_control_bar").addEventListener("input",UI.keepControlbar),document.getElementById("noVNC_control_bar_handle").addEventListener("touchstart",UI.controlbarHandleMouseDown),document.getElementById("noVNC_control_bar_handle").addEventListener("touchend",UI.controlbarHandleMouseUp),document.getElementById("noVNC_control_bar_handle").addEventListener("touchmove",UI.dragControlbarHandle)},addExtraKeysHandlers(){document.getElementById("noVNC_toggle_extra_keys_button").addEventListener("click",UI.toggleExtraKeys),document.getElementById("noVNC_toggle_ctrl_button").addEventListener("click",UI.toggleCtrl),document.getElementById("noVNC_toggle_windows_button").addEventListener("click",UI.toggleWindows),document.getElementById("noVNC_toggle_alt_button").addEventListener("click",UI.toggleAlt),document.getElementById("noVNC_send_tab_button").addEventListener("click",UI.sendTab),document.getElementById("noVNC_send_esc_button").addEventListener("click",UI.sendEsc),document.getElementById("noVNC_send_ctrl_alt_del_button").addEventListener("click",UI.sendCtrlAltDel)},addMachineHandlers(){document.getElementById("noVNC_shutdown_button").addEventListener("click",()=>UI.rfb.machineShutdown()),document.getElementById("noVNC_reboot_button").addEventListener("click",()=>UI.rfb.machineReboot()),document.getElementById("noVNC_reset_button").addEventListener("click",()=>UI.rfb.machineReset()),document.getElementById("noVNC_power_button").addEventListener("click",UI.togglePowerPanel)},addConnectionControlHandlers(){document.getElementById("noVNC_disconnect_button").addEventListener("click",UI.disconnect),document.getElementById("noVNC_connect_button").addEventListener("click",UI.connect),document.getElementById("noVNC_cancel_reconnect_button").addEventListener("click",UI.cancelReconnect),document.getElementById("noVNC_approve_server_button").addEventListener("click",UI.approveServer),document.getElementById("noVNC_reject_server_button").addEventListener("click",UI.rejectServer),document.getElementById("noVNC_credentials_button").addEventListener("click",UI.setCredentials)},addClipboardHandlers(){document.getElementById("noVNC_clipboard_button").addEventListener("click",UI.toggleClipboardPanel),document.getElementById("noVNC_clipboard_text").addEventListener("change",UI.clipboardSend)},addSettingChangeHandler(name,changeFunc){const settingElem=document.getElementById("noVNC_setting_"+name);void 0===changeFunc&&(changeFunc=()=>UI.saveSetting(name)),settingElem.addEventListener("change",changeFunc)},addSettingsHandlers(){document.getElementById("noVNC_settings_button").addEventListener("click",UI.toggleSettingsPanel),UI.addSettingChangeHandler("encrypt"),UI.addSettingChangeHandler("resize"),UI.addSettingChangeHandler("resize",UI.applyResizeMode),UI.addSettingChangeHandler("resize",UI.updateViewClip),UI.addSettingChangeHandler("quality"),UI.addSettingChangeHandler("quality",UI.updateQuality),UI.addSettingChangeHandler("compression"),UI.addSettingChangeHandler("compression",UI.updateCompression),UI.addSettingChangeHandler("view_clip"),UI.addSettingChangeHandler("view_clip",UI.updateViewClip),UI.addSettingChangeHandler("shared"),UI.addSettingChangeHandler("view_only"),UI.addSettingChangeHandler("view_only",UI.updateViewOnly),UI.addSettingChangeHandler("show_dot"),UI.addSettingChangeHandler("show_dot",UI.updateShowDotCursor),UI.addSettingChangeHandler("host"),UI.addSettingChangeHandler("port"),UI.addSettingChangeHandler("path"),UI.addSettingChangeHandler("repeaterID"),UI.addSettingChangeHandler("logging"),UI.addSettingChangeHandler("logging",UI.updateLogging),UI.addSettingChangeHandler("reconnect"),UI.addSettingChangeHandler("reconnect_delay")},addFullscreenHandlers(){document.getElementById("noVNC_fullscreen_button").addEventListener("click",UI.toggleFullscreen),window.addEventListener("fullscreenchange",UI.updateFullscreenButton),window.addEventListener("mozfullscreenchange",UI.updateFullscreenButton),window.addEventListener("webkitfullscreenchange",UI.updateFullscreenButton),window.addEventListener("msfullscreenchange",UI.updateFullscreenButton)},updateVisualState(state){document.documentElement.classList.remove("noVNC_connecting"),document.documentElement.classList.remove("noVNC_connected"),document.documentElement.classList.remove("noVNC_disconnecting"),document.documentElement.classList.remove("noVNC_reconnecting");const transitionElem=document.getElementById("noVNC_transition_text");switch(state){case"init":break;case"connecting":transitionElem.textContent=_("Connecting..."),document.documentElement.classList.add("noVNC_connecting");break;case"connected":document.documentElement.classList.add("noVNC_connected");break;case"disconnecting":transitionElem.textContent=_("Disconnecting..."),document.documentElement.classList.add("noVNC_disconnecting");break;case"disconnected":break;case"reconnecting":transitionElem.textContent=_("Reconnecting..."),document.documentElement.classList.add("noVNC_reconnecting");break;default:return Log.Error("Invalid visual state: "+state),void UI.showStatus(_("Internal error"),"error")}UI.connected?(UI.updateViewClip(),UI.disableSetting("encrypt"),UI.disableSetting("shared"),UI.disableSetting("host"),UI.disableSetting("port"),UI.disableSetting("path"),UI.disableSetting("repeaterID"),UI.closeControlbarTimeout=setTimeout(UI.closeControlbar,2e3)):(UI.enableSetting("encrypt"),UI.enableSetting("shared"),UI.enableSetting("host"),UI.enableSetting("port"),UI.enableSetting("path"),UI.enableSetting("repeaterID"),UI.updatePowerButton(),UI.keepControlbar()),UI.closeAllPanels(),document.getElementById("noVNC_verify_server_dlg").classList.remove("noVNC_open"),document.getElementById("noVNC_credentials_dlg").classList.remove("noVNC_open")},showStatus(text,statusType,time){const statusElem=document.getElementById("noVNC_status");if(void 0===statusType&&(statusType="normal"),statusElem.classList.contains("noVNC_open")){if(statusElem.classList.contains("noVNC_status_error"))return;if(statusElem.classList.contains("noVNC_status_warn")&&"normal"===statusType)return}switch(clearTimeout(UI.statusTimeout),statusType){case"error":statusElem.classList.remove("noVNC_status_warn"),statusElem.classList.remove("noVNC_status_normal"),statusElem.classList.add("noVNC_status_error");break;case"warning":case"warn":statusElem.classList.remove("noVNC_status_error"),statusElem.classList.remove("noVNC_status_normal"),statusElem.classList.add("noVNC_status_warn");break;case"normal":case"info":default:statusElem.classList.remove("noVNC_status_error"),statusElem.classList.remove("noVNC_status_warn"),statusElem.classList.add("noVNC_status_normal")}statusElem.textContent=text,statusElem.classList.add("noVNC_open"),void 0===time&&(time=1500),"error"!==statusType&&(UI.statusTimeout=window.setTimeout(UI.hideStatus,time))},hideStatus(){clearTimeout(UI.statusTimeout),document.getElementById("noVNC_status").classList.remove("noVNC_open")},activateControlbar(event){clearTimeout(UI.idleControlbarTimeout),document.getElementById("noVNC_control_bar_anchor").classList.remove("noVNC_idle"),UI.idleControlbarTimeout=window.setTimeout(UI.idleControlbar,2e3)},idleControlbar(){document.getElementById("noVNC_control_bar").contains(document.activeElement)&&document.hasFocus()?UI.activateControlbar():document.getElementById("noVNC_control_bar_anchor").classList.add("noVNC_idle")},keepControlbar(){clearTimeout(UI.closeControlbarTimeout)},openControlbar(){document.getElementById("noVNC_control_bar").classList.add("noVNC_open")},closeControlbar(){UI.closeAllPanels(),document.getElementById("noVNC_control_bar").classList.remove("noVNC_open"),UI.rfb.focus()},toggleControlbar(){document.getElementById("noVNC_control_bar").classList.contains("noVNC_open")?UI.closeControlbar():UI.openControlbar()},toggleControlbarSide(){const bar=document.getElementById("noVNC_control_bar"),barDisplayStyle=window.getComputedStyle(bar).display;"none"!==barDisplayStyle&&(bar.style.transitionDuration="0s",bar.addEventListener("transitionend",()=>bar.style.transitionDuration=""));const anchor=document.getElementById("noVNC_control_bar_anchor");anchor.classList.contains("noVNC_right")?(WebUtil.writeSetting("controlbar_pos","left"),anchor.classList.remove("noVNC_right")):(WebUtil.writeSetting("controlbar_pos","right"),anchor.classList.add("noVNC_right")),UI.controlbarDrag=!0,UI.showControlbarHint(!1,!1)},showControlbarHint(show,animate=!0){const hint=document.getElementById("noVNC_control_bar_hint");animate?hint.classList.remove("noVNC_notransition"):hint.classList.add("noVNC_notransition"),show?hint.classList.add("noVNC_active"):hint.classList.remove("noVNC_active")},dragControlbarHandle(e){if(!UI.controlbarGrabbed)return;const ptr=getPointerEvent(e),anchor=document.getElementById("noVNC_control_bar_anchor");if(ptr.clientX<.1*window.innerWidth?anchor.classList.contains("noVNC_right")&&UI.toggleControlbarSide():ptr.clientX>.9*window.innerWidth&&(anchor.classList.contains("noVNC_right")||UI.toggleControlbarSide()),!UI.controlbarDrag){const dragDistance=Math.abs(ptr.clientY-UI.controlbarMouseDownClientY);if(dragDistance<dragThreshold)return;UI.controlbarDrag=!0}const eventY=ptr.clientY-UI.controlbarMouseDownOffsetY;UI.moveControlbarHandle(eventY),e.preventDefault(),e.stopPropagation(),UI.keepControlbar(),UI.activateControlbar()},moveControlbarHandle(viewportRelativeY){const handle=document.getElementById("noVNC_control_bar_handle"),handleHeight=handle.getBoundingClientRect().height,controlbarBounds=document.getElementById("noVNC_control_bar").getBoundingClientRect(),margin=10;if(0===handleHeight||0===controlbarBounds.height)return;let newY=viewportRelativeY;newY<controlbarBounds.top+10?newY=controlbarBounds.top+10:newY>controlbarBounds.top+controlbarBounds.height-handleHeight-10&&(newY=controlbarBounds.top+controlbarBounds.height-handleHeight-10),controlbarBounds.height<handleHeight+20&&(newY=controlbarBounds.top+(controlbarBounds.height-handleHeight)/2);const parentRelativeY=newY-controlbarBounds.top;handle.style.transform="translateY("+parentRelativeY+"px)"},updateControlbarHandle(){const handle=document.getElementById("noVNC_control_bar_handle"),handleBounds=handle.getBoundingClientRect();UI.moveControlbarHandle(handleBounds.top)},controlbarHandleMouseUp(e){"mouseup"==e.type&&0!=e.button||(UI.controlbarGrabbed&&!UI.controlbarDrag&&(UI.toggleControlbar(),e.preventDefault(),e.stopPropagation(),UI.keepControlbar(),UI.activateControlbar()),UI.controlbarGrabbed=!1,UI.showControlbarHint(!1))},controlbarHandleMouseDown(e){if("mousedown"==e.type&&0!=e.button)return;const ptr=getPointerEvent(e),handle=document.getElementById("noVNC_control_bar_handle"),bounds=handle.getBoundingClientRect();"mousedown"===e.type&&setCapture(handle),UI.controlbarGrabbed=!0,UI.controlbarDrag=!1,UI.showControlbarHint(!0),UI.controlbarMouseDownClientY=ptr.clientY,UI.controlbarMouseDownOffsetY=ptr.clientY-bounds.top,e.preventDefault(),e.stopPropagation(),UI.keepControlbar(),UI.activateControlbar()},toggleExpander(e){this.classList.contains("noVNC_open")?this.classList.remove("noVNC_open"):this.classList.add("noVNC_open")},initSetting(name,defVal){let val=WebUtil.getConfigVar(name);return null===val&&(val=WebUtil.readSetting(name,defVal)),WebUtil.setSetting(name,val),UI.updateSetting(name),val},forceSetting(name,val){WebUtil.setSetting(name,val),UI.updateSetting(name),UI.disableSetting(name)},updateSetting(name){let value=UI.getSetting(name);const ctrl=document.getElementById("noVNC_setting_"+name);if("checkbox"===ctrl.type)ctrl.checked=value;else if(void 0!==ctrl.options){for(let i=0;i<ctrl.options.length;i+=1)if(ctrl.options[i].value===value){ctrl.selectedIndex=i;break}}else ctrl.value=value},saveSetting(name){const ctrl=document.getElementById("noVNC_setting_"+name);let val;return val="checkbox"===ctrl.type?ctrl.checked:void 0!==ctrl.options?ctrl.options[ctrl.selectedIndex].value:ctrl.value,WebUtil.writeSetting(name,val),val},getSetting(name){const ctrl=document.getElementById("noVNC_setting_"+name);let val=WebUtil.readSetting(name);return null!=val&&"checkbox"===ctrl.type&&(val=!(val.toString().toLowerCase()in{0:1,no:1,false:1})),val},disableSetting(name){const ctrl=document.getElementById("noVNC_setting_"+name);ctrl.disabled=!0,ctrl.label.classList.add("noVNC_disabled")},enableSetting(name){const ctrl=document.getElementById("noVNC_setting_"+name);ctrl.disabled=!1,ctrl.label.classList.remove("noVNC_disabled")},closeAllPanels(){UI.closeSettingsPanel(),UI.closePowerPanel(),UI.closeClipboardPanel(),UI.closeExtraKeys()},openSettingsPanel(){UI.closeAllPanels(),UI.openControlbar(),UI.updateSetting("encrypt"),UI.updateSetting("view_clip"),UI.updateSetting("resize"),UI.updateSetting("quality"),UI.updateSetting("compression"),UI.updateSetting("shared"),UI.updateSetting("view_only"),UI.updateSetting("path"),UI.updateSetting("repeaterID"),UI.updateSetting("logging"),UI.updateSetting("reconnect"),UI.updateSetting("reconnect_delay"),document.getElementById("noVNC_settings").classList.add("noVNC_open"),document.getElementById("noVNC_settings_button").classList.add("noVNC_selected")},closeSettingsPanel(){document.getElementById("noVNC_settings").classList.remove("noVNC_open"),document.getElementById("noVNC_settings_button").classList.remove("noVNC_selected")},toggleSettingsPanel(){document.getElementById("noVNC_settings").classList.contains("noVNC_open")?UI.closeSettingsPanel():UI.openSettingsPanel()},openPowerPanel(){UI.closeAllPanels(),UI.openControlbar(),document.getElementById("noVNC_power").classList.add("noVNC_open"),document.getElementById("noVNC_power_button").classList.add("noVNC_selected")},closePowerPanel(){document.getElementById("noVNC_power").classList.remove("noVNC_open"),document.getElementById("noVNC_power_button").classList.remove("noVNC_selected")},togglePowerPanel(){document.getElementById("noVNC_power").classList.contains("noVNC_open")?UI.closePowerPanel():UI.openPowerPanel()},updatePowerButton(){UI.connected&&UI.rfb.capabilities.power&&!UI.rfb.viewOnly?document.getElementById("noVNC_power_button").classList.remove("noVNC_hidden"):(document.getElementById("noVNC_power_button").classList.add("noVNC_hidden"),UI.closePowerPanel())},openClipboardPanel(){UI.closeAllPanels(),UI.openControlbar(),document.getElementById("noVNC_clipboard").classList.add("noVNC_open"),document.getElementById("noVNC_clipboard_button").classList.add("noVNC_selected")},closeClipboardPanel(){document.getElementById("noVNC_clipboard").classList.remove("noVNC_open"),document.getElementById("noVNC_clipboard_button").classList.remove("noVNC_selected")},toggleClipboardPanel(){document.getElementById("noVNC_clipboard").classList.contains("noVNC_open")?UI.closeClipboardPanel():UI.openClipboardPanel()},clipboardReceive(e){Log.Debug(">> UI.clipboardReceive: "+e.detail.text.substr(0,40)+"..."),document.getElementById("noVNC_clipboard_text").value=e.detail.text,Log.Debug("<< UI.clipboardReceive")},clipboardSend(){const text=document.getElementById("noVNC_clipboard_text").value;Log.Debug(">> UI.clipboardSend: "+text.substr(0,40)+"..."),UI.rfb.clipboardPasteFrom(text),Log.Debug("<< UI.clipboardSend")},openConnectPanel(){document.getElementById("noVNC_connect_dlg").classList.add("noVNC_open")},closeConnectPanel(){document.getElementById("noVNC_connect_dlg").classList.remove("noVNC_open")},connect(event,password){if(void 0!==UI.rfb)return;const host=UI.getSetting("host"),port=UI.getSetting("port"),path=UI.getSetting("path");if(void 0===password&&(password=WebUtil.getConfigVar("password"),UI.reconnectPassword=password),null===password&&(password=void 0),UI.hideStatus(),!host)return Log.Error("Can't connect when host is: "+host),void UI.showStatus(_("Must set host"),"error");let url;UI.closeConnectPanel(),UI.updateVisualState("connecting"),url=UI.getSetting("encrypt")?"wss":"ws",url+="://"+host,port&&(url+=":"+port),url+="/"+path,UI.rfb=new RFB(document.getElementById("noVNC_container"),url,{shared:UI.getSetting("shared"),repeaterID:UI.getSetting("repeaterID"),credentials:{password:password}}),UI.rfb.addEventListener("connect",UI.connectFinished),UI.rfb.addEventListener("disconnect",UI.disconnectFinished),UI.rfb.addEventListener("serververification",UI.serverVerify),UI.rfb.addEventListener("credentialsrequired",UI.credentials),UI.rfb.addEventListener("securityfailure",UI.securityFailed),UI.rfb.addEventListener("capabilities",UI.updatePowerButton),UI.rfb.addEventListener("clipboard",UI.clipboardReceive),UI.rfb.addEventListener("bell",UI.bell),UI.rfb.addEventListener("desktopname",UI.updateDesktopName),UI.rfb.clipViewport=UI.getSetting("view_clip"),UI.rfb.scaleViewport="scale"===UI.getSetting("resize"),UI.rfb.resizeSession="remote"===UI.getSetting("resize"),UI.rfb.qualityLevel=parseInt(UI.getSetting("quality")),UI.rfb.compressionLevel=parseInt(UI.getSetting("compression")),UI.rfb.showDotCursor=UI.getSetting("show_dot"),UI.updateViewOnly()},disconnect(){UI.rfb.disconnect(),UI.connected=!1,UI.inhibitReconnect=!0,UI.updateVisualState("disconnecting")},reconnect(){UI.reconnectCallback=null,UI.inhibitReconnect||UI.connect(null,UI.reconnectPassword)},cancelReconnect(){null!==UI.reconnectCallback&&(clearTimeout(UI.reconnectCallback),UI.reconnectCallback=null),UI.updateVisualState("disconnected"),UI.openControlbar(),UI.openConnectPanel()},connectFinished(e){let msg;UI.connected=!0,UI.inhibitReconnect=!1,msg=UI.getSetting("encrypt")?_("Connected (encrypted) to ")+UI.desktopName:_("Connected (unencrypted) to ")+UI.desktopName,UI.showStatus(msg),UI.updateVisualState("connected"),UI.rfb.focus()},disconnectFinished(e){const wasConnected=UI.connected;if(UI.connected=!1,UI.rfb=void 0,e.detail.clean||(UI.updateVisualState("disconnected"),wasConnected?UI.showStatus(_("Something went wrong, connection is closed"),"error"):UI.showStatus(_("Failed to connect to server"),"error")),!0!==UI.getSetting("reconnect",!1)||UI.inhibitReconnect)UI.updateVisualState("disconnected"),UI.showStatus(_("Disconnected"),"normal"),document.title="noVNC",UI.openControlbar(),UI.openConnectPanel();else{UI.updateVisualState("reconnecting");const delay=parseInt(UI.getSetting("reconnect_delay"));UI.reconnectCallback=setTimeout(UI.reconnect,delay)}},securityFailed(e){let msg="";msg="reason"in e.detail?_("New connection has been rejected with reason: ")+e.detail.reason:_("New connection has been rejected"),UI.showStatus(msg,"error")},async serverVerify(e){const type=e.detail.type;if("RSA"===type){const publickey=e.detail.publickey;let fingerprint=await window.crypto.subtle.digest("SHA-1",publickey);fingerprint=Array.from(new Uint8Array(fingerprint).slice(0,8)).map(x=>x.toString(16).padStart(2,"0")).join("-"),document.getElementById("noVNC_verify_server_dlg").classList.add("noVNC_open"),document.getElementById("noVNC_fingerprint").innerHTML=fingerprint}},approveServer(e){e.preventDefault(),document.getElementById("noVNC_verify_server_dlg").classList.remove("noVNC_open"),UI.rfb.approveServer()},rejectServer(e){e.preventDefault(),document.getElementById("noVNC_verify_server_dlg").classList.remove("noVNC_open"),UI.disconnect()},credentials(e){document.getElementById("noVNC_username_block").classList.remove("noVNC_hidden"),document.getElementById("noVNC_password_block").classList.remove("noVNC_hidden");let inputFocus="none";-1===e.detail.types.indexOf("username")?document.getElementById("noVNC_username_block").classList.add("noVNC_hidden"):inputFocus="none"===inputFocus?"noVNC_username_input":inputFocus,-1===e.detail.types.indexOf("password")?document.getElementById("noVNC_password_block").classList.add("noVNC_hidden"):inputFocus="none"===inputFocus?"noVNC_password_input":inputFocus,document.getElementById("noVNC_credentials_dlg").classList.add("noVNC_open"),setTimeout(()=>document.getElementById(inputFocus).focus(),100),Log.Warn("Server asked for credentials"),UI.showStatus(_("Credentials are required"),"warning")},setCredentials(e){let inputElemUsername;e.preventDefault();const username=document.getElementById("noVNC_username_input").value;let inputElemPassword=document.getElementById("noVNC_password_input");const password=inputElemPassword.value;inputElemPassword.value="",UI.rfb.sendCredentials({username:username,password:password}),UI.reconnectPassword=password,document.getElementById("noVNC_credentials_dlg").classList.remove("noVNC_open")},toggleFullscreen(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen?document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):document.body.msRequestFullscreen&&document.body.msRequestFullscreen(),UI.updateFullscreenButton()},updateFullscreenButton(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.getElementById("noVNC_fullscreen_button").classList.add("noVNC_selected"):document.getElementById("noVNC_fullscreen_button").classList.remove("noVNC_selected")},applyResizeMode(){UI.rfb&&(UI.rfb.scaleViewport="scale"===UI.getSetting("resize"),UI.rfb.resizeSession="remote"===UI.getSetting("resize"))},updateViewClip(){if(!UI.rfb)return;const scaling="scale"===UI.getSetting("resize");scaling?(UI.forceSetting("view_clip",!1),UI.rfb.clipViewport=!1):hasScrollbarGutter?(UI.enableSetting("view_clip"),UI.rfb.clipViewport=UI.getSetting("view_clip")):(UI.forceSetting("view_clip",!0),UI.rfb.clipViewport=!0),UI.updateViewDrag()},toggleViewDrag(){UI.rfb&&(UI.rfb.dragViewport=!UI.rfb.dragViewport,UI.updateViewDrag())},updateViewDrag(){if(!UI.connected)return;const viewDragButton=document.getElementById("noVNC_view_drag_button");!UI.rfb.clipViewport&&UI.rfb.dragViewport&&(UI.rfb.dragViewport=!1),UI.rfb.dragViewport?viewDragButton.classList.add("noVNC_selected"):viewDragButton.classList.remove("noVNC_selected"),UI.rfb.clipViewport?viewDragButton.classList.remove("noVNC_hidden"):viewDragButton.classList.add("noVNC_hidden")},updateQuality(){UI.rfb&&(UI.rfb.qualityLevel=parseInt(UI.getSetting("quality")))},updateCompression(){UI.rfb&&(UI.rfb.compressionLevel=parseInt(UI.getSetting("compression")))},showVirtualKeyboard(){if(!isTouchDevice)return;const input=document.getElementById("noVNC_keyboardinput");if(document.activeElement!=input){input.focus();try{const l=input.value.length;input.setSelectionRange(l,l)}catch(err){}}},hideVirtualKeyboard(){if(!isTouchDevice)return;const input=document.getElementById("noVNC_keyboardinput");document.activeElement==input&&input.blur()},toggleVirtualKeyboard(){document.getElementById("noVNC_keyboard_button").classList.contains("noVNC_selected")?UI.hideVirtualKeyboard():UI.showVirtualKeyboard()},onfocusVirtualKeyboard(event){document.getElementById("noVNC_keyboard_button").classList.add("noVNC_selected"),UI.rfb&&(UI.rfb.focusOnClick=!1)},onblurVirtualKeyboard(event){document.getElementById("noVNC_keyboard_button").classList.remove("noVNC_selected"),UI.rfb&&(UI.rfb.focusOnClick=!0)},keepVirtualKeyboard(event){const input=document.getElementById("noVNC_keyboardinput");if(document.activeElement==input){if(void 0!==event.target.form)switch(event.target.type){case"text":case"email":case"search":case"password":case"tel":case"url":case"textarea":case"select-one":case"select-multiple":return}event.preventDefault()}},keyboardinputReset(){const kbi=document.getElementById("noVNC_keyboardinput");kbi.value=new Array(UI.defaultKeyboardinputLen).join("_"),UI.lastKeyboardinput=kbi.value},keyEvent(keysym,code,down){UI.rfb&&UI.rfb.sendKey(keysym,code,down)},keyInput(event){if(!UI.rfb)return;const newValue=event.target.value;UI.lastKeyboardinput||UI.keyboardinputReset();const oldValue=UI.lastKeyboardinput;let newLen;try{newLen=Math.max(event.target.selectionStart,newValue.length)}catch(err){newLen=newValue.length}const oldLen=oldValue.length;let inputs=newLen-oldLen,backspaces=inputs<0?-inputs:0;for(let i=0;i<Math.min(oldLen,newLen);i++)if(newValue.charAt(i)!=oldValue.charAt(i)){inputs=newLen-i,backspaces=oldLen-i;break}for(let i=0;i<backspaces;i++)UI.rfb.sendKey(KeyTable.XK_BackSpace,"Backspace");for(let i=newLen-inputs;i<newLen;i++)UI.rfb.sendKey(keysyms.lookup(newValue.charCodeAt(i)));newLen>2*UI.defaultKeyboardinputLen?UI.keyboardinputReset():newLen<1?(UI.keyboardinputReset(),event.target.blur(),setTimeout(event.target.focus.bind(event.target),0)):UI.lastKeyboardinput=newValue},openExtraKeys(){UI.closeAllPanels(),UI.openControlbar(),document.getElementById("noVNC_modifiers").classList.add("noVNC_open"),document.getElementById("noVNC_toggle_extra_keys_button").classList.add("noVNC_selected")},closeExtraKeys(){document.getElementById("noVNC_modifiers").classList.remove("noVNC_open"),document.getElementById("noVNC_toggle_extra_keys_button").classList.remove("noVNC_selected")},toggleExtraKeys(){document.getElementById("noVNC_modifiers").classList.contains("noVNC_open")?UI.closeExtraKeys():UI.openExtraKeys()},sendEsc(){UI.sendKey(KeyTable.XK_Escape,"Escape")},sendTab(){UI.sendKey(KeyTable.XK_Tab,"Tab")},toggleCtrl(){const btn=document.getElementById("noVNC_toggle_ctrl_button");btn.classList.contains("noVNC_selected")?(UI.sendKey(KeyTable.XK_Control_L,"ControlLeft",!1),btn.classList.remove("noVNC_selected")):(UI.sendKey(KeyTable.XK_Control_L,"ControlLeft",!0),btn.classList.add("noVNC_selected"))},toggleWindows(){const btn=document.getElementById("noVNC_toggle_windows_button");btn.classList.contains("noVNC_selected")?(UI.sendKey(KeyTable.XK_Super_L,"MetaLeft",!1),btn.classList.remove("noVNC_selected")):(UI.sendKey(KeyTable.XK_Super_L,"MetaLeft",!0),btn.classList.add("noVNC_selected"))},toggleAlt(){const btn=document.getElementById("noVNC_toggle_alt_button");btn.classList.contains("noVNC_selected")?(UI.sendKey(KeyTable.XK_Alt_L,"AltLeft",!1),btn.classList.remove("noVNC_selected")):(UI.sendKey(KeyTable.XK_Alt_L,"AltLeft",!0),btn.classList.add("noVNC_selected"))},sendCtrlAltDel(){UI.rfb.sendCtrlAltDel(),UI.rfb.focus(),UI.idleControlbar()},sendKey(keysym,code,down){UI.rfb.sendKey(keysym,code,down),document.getElementById("noVNC_keyboard_button").classList.contains("noVNC_selected")?document.getElementById("noVNC_keyboardinput").focus():UI.rfb.focus(),UI.idleControlbar()},updateViewOnly(){UI.rfb&&(UI.rfb.viewOnly=UI.getSetting("view_only"),UI.rfb.viewOnly?(document.getElementById("noVNC_keyboard_button").classList.add("noVNC_hidden"),document.getElementById("noVNC_toggle_extra_keys_button").classList.add("noVNC_hidden"),document.getElementById("noVNC_clipboard_button").classList.add("noVNC_hidden")):(document.getElementById("noVNC_keyboard_button").classList.remove("noVNC_hidden"),document.getElementById("noVNC_toggle_extra_keys_button").classList.remove("noVNC_hidden"),document.getElementById("noVNC_clipboard_button").classList.remove("noVNC_hidden")))},updateShowDotCursor(){UI.rfb&&(UI.rfb.showDotCursor=UI.getSetting("show_dot"))},updateLogging(){WebUtil.initLogging(UI.getSetting("logging"))},updateDesktopName(e){UI.desktopName=e.detail.name,document.title=e.detail.name+" - noVNC"},bell(e){if("on"===WebUtil.getConfigVar("bell","on")){const promise=document.getElementById("noVNC_bell").play();promise&&promise.catch(e=>{"NotAllowedError"===e.name||Log.Error("Unable to play bell: "+e)})}},addOption(selectbox,text,value){const optn=document.createElement("OPTION");optn.text=text,optn.value=value,selectbox.options.add(optn)}},LINGUAS=["cs","de","el","es","fr","it","ja","ko","nl","pl","pt_BR","ru","sv","tr","zh_CN","zh_TW"];l10n.setup(LINGUAS),"en"===l10n.language||void 0!==l10n.dictionary?UI.prime():fetch("/json/novnc/"+l10n.language+".json").then(response=>{if(!response.ok)throw Error(response.status+" "+response.statusText);return response.json()}).then(translations=>{l10n.dictionary=translations}).catch(err=>Log.Error("Failed to load translations: "+err)).then(UI.prime);export default UI;