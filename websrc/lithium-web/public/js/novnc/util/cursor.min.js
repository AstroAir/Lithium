import{supportsCursorURIs,isTouchDevice}from"./browser.min.js";const useFallback=!supportsCursorURIs||isTouchDevice;export default class Cursor{constructor(){this._target=null,this._canvas=document.createElement("canvas"),useFallback&&(this._canvas.style.position="fixed",this._canvas.style.zIndex="65535",this._canvas.style.pointerEvents="none",this._canvas.style.userSelect="none",this._canvas.style.WebkitUserSelect="none",this._canvas.style.visibility="hidden"),this._position={x:0,y:0},this._hotSpot={x:0,y:0},this._eventHandlers={mouseover:this._handleMouseOver.bind(this),mouseleave:this._handleMouseLeave.bind(this),mousemove:this._handleMouseMove.bind(this),mouseup:this._handleMouseUp.bind(this)}}attach(target){if(this._target&&this.detach(),this._target=target,useFallback){document.body.appendChild(this._canvas);const options={capture:!0,passive:!0};this._target.addEventListener("mouseover",this._eventHandlers.mouseover,options),this._target.addEventListener("mouseleave",this._eventHandlers.mouseleave,options),this._target.addEventListener("mousemove",this._eventHandlers.mousemove,options),this._target.addEventListener("mouseup",this._eventHandlers.mouseup,options)}this.clear()}detach(){if(this._target){if(useFallback){const options={capture:!0,passive:!0};this._target.removeEventListener("mouseover",this._eventHandlers.mouseover,options),this._target.removeEventListener("mouseleave",this._eventHandlers.mouseleave,options),this._target.removeEventListener("mousemove",this._eventHandlers.mousemove,options),this._target.removeEventListener("mouseup",this._eventHandlers.mouseup,options),document.body.removeChild(this._canvas)}this._target=null}}change(rgba,hotx,hoty,w,h){if(0===w||0===h)return void this.clear();this._position.x=this._position.x+this._hotSpot.x-hotx,this._position.y=this._position.y+this._hotSpot.y-hoty,this._hotSpot.x=hotx,this._hotSpot.y=hoty;let ctx=this._canvas.getContext("2d");this._canvas.width=w,this._canvas.height=h;let img=new ImageData(new Uint8ClampedArray(rgba),w,h);if(ctx.clearRect(0,0,w,h),ctx.putImageData(img,0,0),useFallback)this._updatePosition();else{let url=this._canvas.toDataURL();this._target.style.cursor="url("+url+")"+hotx+" "+hoty+", default"}}clear(){this._target.style.cursor="none",this._canvas.width=0,this._canvas.height=0,this._position.x=this._position.x+this._hotSpot.x,this._position.y=this._position.y+this._hotSpot.y,this._hotSpot.x=0,this._hotSpot.y=0}move(clientX,clientY){if(!useFallback)return;window.visualViewport?(this._position.x=clientX+window.visualViewport.offsetLeft,this._position.y=clientY+window.visualViewport.offsetTop):(this._position.x=clientX,this._position.y=clientY),this._updatePosition();let target=document.elementFromPoint(clientX,clientY);this._updateVisibility(target)}_handleMouseOver(event){this._handleMouseMove(event)}_handleMouseLeave(event){this._updateVisibility(event.relatedTarget)}_handleMouseMove(event){this._updateVisibility(event.target),this._position.x=event.clientX-this._hotSpot.x,this._position.y=event.clientY-this._hotSpot.y,this._updatePosition()}_handleMouseUp(event){let target=document.elementFromPoint(event.clientX,event.clientY);this._updateVisibility(target),this._captureIsActive()&&window.setTimeout(()=>{this._target&&(target=document.elementFromPoint(event.clientX,event.clientY),this._updateVisibility(target))},0)}_showCursor(){"hidden"===this._canvas.style.visibility&&(this._canvas.style.visibility="")}_hideCursor(){"hidden"!==this._canvas.style.visibility&&(this._canvas.style.visibility="hidden")}_shouldShowCursor(target){return!!target&&(target===this._target||!!this._target.contains(target)&&"none"===window.getComputedStyle(target).cursor)}_updateVisibility(target){this._captureIsActive()&&(target=document.captureElement),this._shouldShowCursor(target)?this._showCursor():this._hideCursor()}_updatePosition(){this._canvas.style.left=this._position.x+"px",this._canvas.style.top=this._position.y+"px"}_captureIsActive(){return document.captureElement&&document.documentElement.contains(document.captureElement)}}