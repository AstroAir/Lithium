# ASTAP 命令行

该程序可以通过命令行选项执行以解决图像的天文测量问题。例如：

```bash
ASTAP -f home/test/2.fits -r 30
```

可以输入 FITS、TIFF、PNG、JPG、BMP 和未压缩的 XISF 文件。

## ASTAP 命令行

**FOV、RA、DEC 选项**适用于非 FITS 文件。对于在头文件中包含这些值的 FITS 文件，这些选项不是必需的。

### 命令

| 参数  | 单位 | 备注     |
| ----- | ---- | -------- |
| -h    |      | 帮助信息 |
| -help |      | 帮助信息 |

### 求解器选项

| 命令    | 参数              | 单位      | 备注                                                                                                                    |
| ------- | ----------------- | --------- | ----------------------------------------------------------------------------------------------------------------------- |
| -f      | 文件名            |           | 需要解析的文件。                                                                                                        |
| -r      | 搜索半径          | 度        | 将在起始位置周围的方形螺旋中搜索，直到此半径 \*                                                                         |
| -fov    | 图像高度          | 度        | 可选。通常从 FITS 头文件中计算。使用值 0 进行自动计算。如果指定 0，求解后找到的 fov 将保存以供下次使用。（学习模式） \* |
| -ra     | 中心赤经          | 小时      | 可选起始值。通常从 FITS 头文件中计算。                                                                                  |
| -spd    | 南极距离 (dec+90) | 度        | 通常从 FITS 头文件中计算 \* 赤纬以南极距离给出，因此总是正值。                                                          |
| -z      | 降采样因子        | 0,1,2,3,4 | 求解前降采样。也称为分箱。值 "0" 将导致自动选择降采样。 \*                                                              |
| -s      | 最大星数          |           | 限制用于求解的星数。典型值 500。 \*                                                                                     |
| -t      | 容差              |           | 用于比较四边形的容差。典型值 0.007。 \*                                                                                 |
| -m      | 最小星大小        | 角秒      | 可用于过滤掉热点像素。                                                                                                  |
| -check  | 应用              | y/n       | 求解前应用检查模式过滤器。仅在分箱为 1x1 时用于原始 OSC 图像 \*                                                         |
| -d      | 路径              |           | 指定星数据库的路径                                                                                                      |
| -D      | 缩写              |           | 指定星数据库 [d80, d50, ..]                                                                                             |
| -o      | 文件              |           | 使用此基本路径和文件名命名输出文件                                                                                      |
| -sip    | 添加              | y/n       | 添加 SIP（简单图像多项式）系数。注意，该参数仅在需要停用 SIP 时才需要。                                                 |
| -speed  | 模式              | 慢 / 自动 | "慢" 模式强制从星数据库中读取更大区域（更多重叠）以提高检测率。 \*                                                      |
| -wcs    |                   |           | WCS 文件 以类似 Astrometry.net 的格式写入。否则为文本样式                                                               |
| -update |                   |           | 使用找到的解决方案更新 fits/tiff 头文件。Jpeg、png 将写为 fits。                                                        |
| -log    |                   |           | 将求解器日志写入扩展名为 .log 的文件                                                                                    |

### 分析选项

| 命令      | 参数       | 单位 | 备注                                                                                                                                                    |
| --------- | ---------- | ---- | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| -analyse  | 最小信噪比 |      | 仅分析并报告 HFD。Windows：errorlevel 是中值 HFD \* 100M + 使用的星数。因此 HFD 是 trunc(errorlevel/1M)/100。对于 Linux 和 macOS，信息仅发送到 stdout。 |
| -extract  | 最小信噪比 |      | 如分析选项，但另外将所有可检测星的信息导出到 .csv 文件。小数分隔符始终为点。                                                                            |
| -extract2 | 最小信噪比 |      | 求解图像并将所有可检测星的信息导出到 .csv 文件，包括每次检测的 α, δ。将使用 SIP 多项式以获得高精度位置。小数分隔符始终为点。                            |

### 额外选项（仅适用于标准 GUI 版本）

| 命令      | 参数 | 单位    | 备注                                                                           |
| --------- | ---- | ------- | ------------------------------------------------------------------------------ |
| -annotate |      |         | 生成一个带有深空注释的 jpeg 文件，文件名与输入文件相同，扩展名为 \_annotated。 |
| -debug    |      |         | 显示 GUI 并在求解前停止                                                        |
| -tofits   | 分箱 | 1,2,3,4 | 从输入的 png/jpg 生成分箱的 FITS 文件                                          |

### 作为分析器/堆栈器

| 命令    | 参数                                                              | 单位 | 备注                                                                                                              |
| ------- | ----------------------------------------------------------------- | ---- | ----------------------------------------------------------------------------------------------------------------- |
| -sqm    | 基座                                                              |      | 测量相对于星的天空背景值，单位为 magn/arcsec2。基座是暗场的平均值。还将写入 centalt 和 airmass 到头文件。         |
| -focus1 | file1.fits -focus2 file2.fits -focus3 file3.fits ................ |      | 使用曲线拟合为四个或更多图像找到最佳焦点。Windows：errorlevel 是 focuspos*1E4 + rem.error*1E3。Linux：查看 stdout |
| -stack  |                                                                   |      | 启动 ASTAP 并显示可见的实时堆栈标签和选定的路径。                                                                 |

### 命令行参数优先级

命令行参数优先于 fits 头文件值。前端程序应提供对 -z 和 -r 选项的访问。-z 的默认值应为 0（自动）。

### 典型命令行

```bash
astap.exe -f image.fits -r 50
astap.exe -f c:\images\image.png -ra 23.000 -spd 179.000 -fov 1.3 -r 50
```

对于大多数 FITS 文件，命令行可以很短，因为望远镜位置和视场可以从 FITS 头文件中检索。如果没有 FITS 文件，首选是非无损图像格式，如 .PNG 或 .TIFF 或 RAW 格式，如 .CR2。如果可能，使用 16 位或原始 12 位格式。不要拉伸或饱和，尽可能原始。对于非 FITS 格式，应添加 RA、DEC 位置和 -fov（图像高度，单位为度！！）。

如果在 RAW、PNG、TIFF 文件的命令行中未指定 FOV（图像高度，单位为度），ASTAP 将使用程序、堆栈菜单、对齐标签中设置的 FOV。此设置可以通过参数 -fov 0 自动学习和更新。ASTAP 将尝试所有 FOV 在 10 度和 0.3 度之间。例如：

```bash
astap.exe -f c:\images\image.png -ra 23.000 -spd 179.000 -r 30 -fov 0
```

成功求解后，正确的 FOV 将存储在 ASTAP 设置中。对于下次使用相同来源的图像求解，可以省略 -fov 0 参数，求解将更快。

### 调试选项

调试选项允许在 GUI（图形用户界面）中设置一些求解参数并测试命令行。在调试模式下，所有命令行参数都已设置，指定的图像显示在查看器中。只需手动给出求解命令：

```bash
astap.exe -f c:\images\image.png -ra 23.000 -spd 179.000 -r 30 -debug
```

或

```bash
astap.exe -debug
```

### 命令行，输出文件

在命令行模式下，程序在与输入图像相同的位置生成两个输出文件。如果找到解决方案，它将写入一个 .wcs 文件 1)，仅包含已解决的 FITS 头文件。在任何情况下，它将使用标准 FITS 关键字写入一个 INI 文件。

#### 成功求解后的 INI 输出文件示例

```ini
PLTSOLVD=T                                     // T=true, F=false
CRPIX1= 1.1645000000000000E+003                // 参考和中心像素的 X
CRPIX2= 8.8050000000000000E+002                // 参考和中心像素的 Y
CRVAL1= 1.5463033992314939E+002                // 参考像素的 RA (J2000) [度]
CRVAL2= 2.2039358425145043E+001                // 参考像素的 DEC (J2000) [度]
CDELT1=-7.4798001762187193E-004                // X 像素大小 [度]
CDELT2= 7.4845252983311850E-004                // Y 像素大小 [度]
CROTA1=-1.1668387329628058E+000                // X 轴图像扭曲 [度]
CROTA2=-1.1900321176194073E+000                // Y 轴图像扭曲 [度]
CD1_1=-7.4781868711882519E-004                 // CD 矩阵将 (x,y) 转换为 (Ra, Dec)
CD1_2= 1.5241315209850368E-005                 // CD 矩阵将 (x,y) 转换为 (Ra, Dec)
CD2_1= 1.5534412042060001E-005                 // CD 矩阵将 (x,y) 转换为 (Ra, Dec)
CD2_2= 7.4829732842251226E-004                 // CD 矩阵将 (x,y) 转换为 (Ra, Dec)
CMDLINE=......                                 // 包含使用的命令行的文本消息
WARNING=......                                 // 包含警告的文本消息
```

#### 求解失败时的 INI 输出文件示例

```ini
PLTSOLVD=F                                     // T=true, F=false
CMDLINE=......                                 // 包含使用的命令行的文本消息
ERROR= .....                                   // 包含任何错误的文本消息。与退出代码错误相同
WARNING= .....                                 // 包含任何警告的文本消息
```

.wcs 文件包含原始 FITS 头文件，并添加了解决方案。没有数据，只有头文件。任何警告都使用关键字 WARNING 添加到 .wcs 文件中。此警告可以向用户显示以供信息。

1. 注意 wcs 文件默认写为文本文件，每行使用回车和换行，不符合 FITS 标准。要使 .wcs 文件符合 FITS 标准，请添加命令行选项 -wcs。

### 命令行，错误代码

在命令行模式下，错误通过错误代码 / errorlevel {%errorlevel%} 报告。这与失败时在 .ini 文件中报告的错误相同。

| 错误代码 | 描述               |
| -------- | ------------------ |
| 0        | 无错误             |
| 1        | 无解决方案         |
| 2        | 检测到的星数不足   |
| 16       | 读取图像文件时出错 |
| 32       | 未找到星数据库     |
| 33       | 读取星数据库时出错 |
| 34       | 更新输入文件时出错 |

### 分析 FITS 文件

要分析 FITS 文件，可以在 Windows 批处理文件中执行以下操作：

```bash
c:\astap.fpc\astap.exe -f c:\astap.fpc\test_files\command_line_test\m16.fit -analyse 30
echo Exit Code is %errorlevel%
pause
```

你将得到

```bash
Exit Code is 326000666
```

其中 HFD 为 3.26，使用 666 颗星

对于 Linux 和 Mac，stdout 报告如下：

```bash
HFD_MEDIAN=3.3
STARS=666
```

### -analyse 功能

| 程序      | Windows           | Linux  | macOS  |
| --------- | ----------------- | ------ | ------ |
| astap     | 退出代码          | stdout | stdout |
| astap_cli | 退出代码 & stdout | stdout | stdout |

### 基于四个或更多输入图像找到最佳焦点

```bash
c:\astap.fpc\astap -focus1 D:\temp\FocusSample\FOCUS04689.fit -focus2 D:\temp\FocusSample\FOCUS05039.fit -focus3 D:\temp\FocusSample\FOCUS05389.fit -focus4 D:\temp\FocusSample\FOCUS05739.fit -focus5 D:\temp\FocusSample\FOCUS06089.fit -focus6 D:\temp\FocusSample\FOCUS06439.fit -focus7 D:\temp\FocusSample\FOCUS06789.fit -focus8 D:\temp\FocusSample\FOCUS07139.fit
echo Exit Code is %errorlevel%
pause
```

或使用 -debug 选项

```bash
astap.exe -debug -focus1 D:\temp\FocusSample\FOCUS04689.fit -focus2 D:\temp\FocusSample\FOCUS05039.fit -focus3 D:\temp\FocusSample\FOCUS05389.fit -focus4 D:\temp\FocusSample\FOCUS05739.fit -focus5 D:\temp\FocusSample\FOCUS06089.fit -focus6 D:\temp\FocusSample\FOCUS06439.fit -focus7 D:\temp\FocusSample\FOCUS06789.fit -focus8 D:\temp\FocusSample\FOCUS07139.fit
```

然后选择 "inspector" 标签并点击 "hyperbola curve fitting button" 以测试功能。

以下是命令行输出的示例：

此选项不适用于 astap_cli 版本。

### 命令行弹出通知器

如果 ASTAP 在 MS-Windows 中通过命令行执行，它将显示在状态栏右侧的小 ASTAP 托盘图标。如果将鼠标移到 ASTAP 托盘图标上，提示将显示搜索半径。要刷新值，请将鼠标移开再移回。

如果搜索螺旋已从起始位置达到 2 度以上的距离，则弹出通知器将显示实际搜索距离和求解器设置：

第一行指示从起始位置的搜索螺旋距离（8º）和最大搜索半径（90º）
图像高度，单位为度。
降采样设置和输入图像的尺寸以进行求解。
起始位置的 α 和 δ。
速度正常（▶▶）或小步（▶）

查看解决求解失败所需的条件。或测试图像是否可求解。
在最新的 Win10 版本中，托盘图标默认关闭。要设置 ASTAP 托盘图标，请通过成像程序启动求解，转到 Windows "设置"，"任务栏"，"打开或关闭系统图标"，并将 ASTAP 托盘图标永久设置为 "打开"，如下所示：

### 盲求解性能

90 度偏移的盲求解性能：

ASTAP 盲求解器性能，90 度偏移。

求解曝光 50 秒的 M16 单色图像，2328x1760 像素，覆盖 1.75 x 1.32° 的视场，起始位置偏北 90 度。使用的数据库为 D50

| 最大星数 | 天文测量求解时间 |
| -------- | ---------------- |
| 500      | 23.8 秒          |
| 300      | 9.8 秒           |
| 200      | 6.7 秒           |
| 100      | 4.8 秒           |

减少 "最大星数" 将导致求解更快，但也会增加求解失败的风险。
